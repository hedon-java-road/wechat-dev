services:
  mysql:
    image: mysql:8.0.33
    container_name: wechat-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: nacos_config
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - /Users/hedon/docker-volumes/mysql/data:/var/lib/mysql
      - /Users/hedon/docker-volumes/mysql/conf:/etc/mysql/conf.d
      - /Users/hedon/docker-volumes/mysql/logs:/var/log/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - wechat-network

  redis:
    image: redis:7.4.0
    container_name: wechat-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - /Users/hedon/docker-volumes/redis/data:/data
      - /Users/hedon/docker-volumes/redis/conf:/usr/local/etc/redis
    command: redis-server --appendonly yes
    networks:
      - wechat-network

  nacos:
    image: nacos/nacos-server:v2.5.2
    container_name: wechat-nacos
    restart: always
    environment:
      MODE: standalone
      PREFER_HOST_MODE: hostname
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: wechat-mysql
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_USER: root
      MYSQL_SERVICE_PASSWORD: root
      MYSQL_SERVICE_DB_PARAM: characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      NACOS_AUTH_ENABLE: true
      NACOS_AUTH_TOKEN: SecretKey012345678901234567890123456789012345678901234567890123456789
      NACOS_AUTH_IDENTITY_KEY: nacos
      NACOS_AUTH_IDENTITY_VALUE: nacos
      JVM_XMS: 512m
      JVM_XMX: 512m
      JVM_XMN: 256m
      TZ: Asia/Shanghai
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
      - "7848:7848"
    volumes:
      - /Users/hedon/docker-volumes/nacos/logs:/home/nacos/logs
      - /Users/hedon/docker-volumes/nacos/data:/home/nacos/data
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - wechat-network

networks:
  wechat-network:
    driver: bridge

